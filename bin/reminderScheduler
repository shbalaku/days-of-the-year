#!/usr/bin/env node

var now = new Date();
var methods = require('./../methods.js');

var client = methods.createClient();

var d = encodeToday();
var date = methods.formatDate(d);

client.connect(function(err) {
  if (err) throw err;
  //console.log(d);
  //console.log(date);
  client.query('SELECT * FROM reminders WHERE remind_on = $1;', [date[0]], function(err, res){
    if (err) throw err;
    client.end(function(err){
      if (err) throw err;
      //console.log(res.rows);
      var len = res.rows.length;
      //console.log(len);
      if(len > 0) {
        for (var i = 0; i < len; i++) {
          var email = res.rows[i].email;
          var personId = res.rows[i].person_id;
          var day = res.rows[i].day;
          var text = "@" + email + " it is " + day + " today!";
          console.log(text);
          var message = {
            user: personId
          };

          methods.createBot(function(bot){
            console.log(message);
            bot.startPrivateConversation(message, function(err, convo) {
              var text = "It is " + day + " today!";
              console.log(text);
              convo.say(text);
            });
          });
        }
      }
    });
  });
});

function encodeToday() {
  var d;
  if (now.getMonth()+1<10)
      mon = '0'+(now.getMonth()+1).toString();
  else
      mon = (now.getMonth()+1).toString();
  if (now.getDate()<10)
      day = '0'+now.getDate().toString();
  else
      day = now.getDate().toString();
  d = mon + "/" + day;

  return d;
}
